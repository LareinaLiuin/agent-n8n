import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';

// åŠ è½½ç¯å¢ƒå˜é‡
dotenv.config();

const app = express();
const PORT = process.env.PORT || 3001;

// ä¸­é—´ä»¶
app.use(cors({
  origin: true,
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));

app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ extended: true }));

// å¥åº·æ£€æŸ¥
app.get('/health', (req, res) => {
  res.json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    app: 'n8n Agent Assistant',
    version: '1.0.0',
    message: 'Backend is running'
  });
});

// æ ¹è·¯å¾„
app.get('/', (req, res) => {
  res.json({
    message: 'n8n Agent Assistant Backend API',
    version: '1.0.0',
    endpoints: {
      health: '/health',
      session: '/api/chat/session',
      message: '/api/chat/message'
    }
  });
});

// èŠå¤©ä¼šè¯åˆ›å»º
app.post('/api/chat/session', (req, res) => {
  const sessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

  console.log('Creating session:', sessionId);

  res.json({
    success: true,
    data: {
      sessionId: sessionId,
      session: {
        id: sessionId,
        createdAt: new Date().toISOString()
      }
    }
  });
});

// èŠå¤©æ¶ˆæ¯å¤„ç†
app.post('/api/chat/message', async (req, res) => {
  try {
    console.log('Received message request:', req.body);

    const { message } = req.body;

    if (!message) {
      return res.status(400).json({
        success: false,
        error: 'Message is required'
      });
    }

    console.log('Processing message:', message);

    // ç”ŸæˆAIå›å¤
    const aiResponse = generateAIResponse(message);

    const response = {
      success: true,
      data: {
        message: {
          id: 'msg-' + Date.now(),
          role: 'assistant',
          content: aiResponse,
          timestamp: new Date().toISOString()
        }
      }
    };

    console.log('Sending response:', JSON.stringify(response, null, 2));
    res.json(response);

  } catch (error: any) {
    console.error('Error processing message:', error);
    res.status(500).json({
      success: false,
      error: 'Internal server error',
      message: error.message
    });
  }
});

// ç”ŸæˆAIå›å¤çš„å‡½æ•°
function generateAIResponse(userMessage: string): string {
  const lowerMessage = userMessage.toLowerCase();

  // åŸºäºå…³é”®è¯ç”Ÿæˆç›¸å…³å›å¤
  if (lowerMessage.includes('é‚®ä»¶') || lowerMessage.includes('email')) {
    return `# é‚®ä»¶è‡ªåŠ¨åŒ–å·¥ä½œæµè®¾è®¡

## ğŸ“§ **é‚®ä»¶å¤„ç†è‡ªåŠ¨åŒ–æ–¹æ¡ˆ**

### **ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºè§¦å‘å™¨**
1. **Gmail è§¦å‘å™¨**
   - é€‰æ‹© "Email Trigger" èŠ‚ç‚¹
   - é…ç½®é‚®ç®±è´¦æˆ·å’Œè®¤è¯
   - è®¾ç½®è¿‡æ»¤æ¡ä»¶ï¼ˆå¦‚ï¼šæœªè¯»é‚®ä»¶ã€ç‰¹å®šå‘ä»¶äººï¼‰

### **ç¬¬äºŒæ­¥ï¼šæ•°æ®å¤„ç†**
2. **æ¡ä»¶åˆ¤æ–­èŠ‚ç‚¹**
   - æ£€æŸ¥é‚®ä»¶å†…å®¹å…³é”®è¯
   - æ ¹æ®é‚®ä»¶ç±»å‹åˆ†ç±»å¤„ç†

3. **æ•°æ®æå–èŠ‚ç‚¹**
   - æå–é‚®ä»¶æ­£æ–‡
   - è§£æå‘ä»¶äººä¿¡æ¯
   - è·å–é™„ä»¶ï¼ˆå¦‚æœ‰ï¼‰

### **ç¬¬ä¸‰æ­¥ï¼šè‡ªåŠ¨åŒ–æ“ä½œ**
4. **åˆ†æ”¯å¤„ç†**
   - **é‡è¦é‚®ä»¶**ï¼šå‘é€é€šçŸ¥åˆ°Slack/Teams
   - **æ™®é€šé‚®ä»¶**ï¼šè‡ªåŠ¨åˆ†ç±»å½’æ¡£
   - **åƒåœ¾é‚®ä»¶**ï¼šç›´æ¥åˆ é™¤

5. **å“åº”ç”Ÿæˆ**
   - ä½¿ç”¨AIç”Ÿæˆè‡ªåŠ¨å›å¤
   - å‘é€ç¡®è®¤é‚®ä»¶

### **ç¬¬å››æ­¥ï¼šè¾“å‡ºä¸è®°å½•**
6. **æ•°æ®å­˜å‚¨**
   - å°†å¤„ç†ç»“æœå­˜å…¥æ•°æ®åº“
   - ç”Ÿæˆå¤„ç†æŠ¥å‘Š

7. **é€šçŸ¥ç³»ç»Ÿ**
   - Webhooké€šçŸ¥å…¶ä»–ç³»ç»Ÿ
   - å‘é€å¤„ç†æ‘˜è¦

## ğŸš€ **å¼€å§‹å®æ–½å»ºè®®**
1. å…ˆä»ç®€å•çš„é‚®ä»¶æ¥æ”¶å¼€å§‹
2. é€æ­¥æ·»åŠ æ•°æ®å¤„ç†é€»è¾‘
3. æµ‹è¯•å„ç§é‚®ä»¶åœºæ™¯
4. ä¼˜åŒ–æ€§èƒ½å’Œé”™è¯¯å¤„ç†

éœ€è¦æˆ‘è¯¦ç»†è§£é‡ŠæŸä¸ªå…·ä½“æ­¥éª¤å—ï¼Ÿ`;
  }

  if (lowerMessage.includes('ç¤¾äº¤åª’ä½“') || lowerMessage.includes('social')) {
    return `# ç¤¾äº¤åª’ä½“å†…å®¹å‘å¸ƒè‡ªåŠ¨åŒ–

## ğŸ“± **ç¤¾äº¤åª’ä½“ç®¡ç†è‡ªåŠ¨åŒ–**

### **ç¬¬ä¸€æ­¥ï¼šå†…å®¹è¾“å…¥è§¦å‘**
1. **å®šæ—¶è§¦å‘å™¨**
   - è®¾ç½®å‘å¸ƒæ—¶é—´è¡¨
   - é…ç½®å†…å®¹æ¥æºï¼ˆRSSã€æ–‡æ¡£ç­‰ï¼‰

2. **æ‰‹åŠ¨è§¦å‘å™¨**
   - Webhookæ¥æ”¶å†…å®¹
   - è¡¨å•æäº¤è§¦å‘

### **ç¬¬äºŒæ­¥ï¼šå†…å®¹å¤„ç†**
3. **å†…å®¹æ ¼å¼åŒ–**
   - æ ¹æ®å¹³å°è°ƒæ•´æ ¼å¼
   - æ·»åŠ å¹³å°ç‰¹å®šæ ‡ç­¾
   - ç”Ÿæˆå›¾ç‰‡/è§†é¢‘é¢„è§ˆ

4. **å†…å®¹å®¡æ ¸**
   - AIå†…å®¹æ£€æŸ¥
   - å…³é”®è¯è¿‡æ»¤
   - åˆè§„æ€§éªŒè¯

### **ç¬¬ä¸‰æ­¥ï¼šå¤šå¹³å°å‘å¸ƒ**
5. **å¹³å°é€‚é…**
   - **å¾®åš**ï¼šå­—æ•°é™åˆ¶ã€è¯é¢˜æ ‡ç­¾
   - **å¾®ä¿¡å…¬ä¼—å·**ï¼šé•¿æ–‡æ ¼å¼ã€æ’ç‰ˆ
   - **LinkedIn**ï¼šä¸“ä¸šè¯­æ°”ã€è¡Œä¸šæ ‡ç­¾
   - **Twitter**ï¼šç®€çŸ­æœ‰åŠ›ã€äº’åŠ¨å…ƒç´ 

6. **å‘å¸ƒè°ƒåº¦**
   - é”™å³°å‘å¸ƒ
   - æ—¶åŒºé€‚é…
   - é‡è¯•æœºåˆ¶

### **ç¬¬å››æ­¥ï¼šç›‘æ§ä¸åˆ†æ**
7. **å‘å¸ƒåè·Ÿè¸ª**
   - ç›‘æ§äº’åŠ¨æ•°æ®
   - æ”¶é›†ç”¨æˆ·åé¦ˆ
   - ç”Ÿæˆå‘å¸ƒæŠ¥å‘Š

8. **ä¼˜åŒ–å»ºè®®**
   - åˆ†ææœ€ä½³å‘å¸ƒæ—¶é—´
   - å†…å®¹æ•ˆæœå¯¹æ¯”
   - è‡ªåŠ¨è°ƒæ•´ç­–ç•¥

## ğŸ’¡ **å®æ–½è¦ç‚¹**
- å†…å®¹è´¨é‡ç®¡ç†
- å¹³å°è§„åˆ™éµå®ˆ
- äº’åŠ¨åŠæ—¶å“åº”
- æ•°æ®æŒç»­ä¼˜åŒ–

éœ€è¦æˆ‘è¯¦ç»†è¯´æ˜æŸä¸ªå¹³å°çš„é…ç½®å—ï¼Ÿ`;
  }

  if (lowerMessage.includes('æ•°æ®') || lowerMessage.includes('data')) {
    return `# æ•°æ®åŒæ­¥è‡ªåŠ¨åŒ–å·¥ä½œæµ

## ğŸ”„ **æ•°æ®åŒæ­¥è§£å†³æ–¹æ¡ˆ**

### **ç¬¬ä¸€æ­¥ï¼šæ•°æ®æºé…ç½®**
1. **è§¦å‘å™¨è®¾ç½®**
   - **æ•°æ®åº“è§¦å‘å™¨**ï¼šæ•°æ®å˜æ›´ç›‘å¬
   - **APIè§¦å‘å™¨**ï¼šå®šæ—¶æ‹‰å–æ•°æ®
   - **æ–‡ä»¶è§¦å‘å™¨**ï¼šæ–‡ä»¶ä¸Šä¼ æ£€æµ‹

2. **è¿æ¥å™¨é…ç½®**
   - **MySQL/PostgreSQL**ï¼šæ•°æ®åº“è¿æ¥
   - **REST API**ï¼šç¬¬ä¸‰æ–¹æ•°æ®æ¥å£
   - **äº‘å­˜å‚¨**ï¼šGoogle Drive, OneDriveç­‰

### **ç¬¬äºŒæ­¥ï¼šæ•°æ®è½¬æ¢**
3. **æ•°æ®æ¸…æ´—**
   - æ ¼å¼æ ‡å‡†åŒ–
   - ç©ºå€¼å¤„ç†
   - æ•°æ®éªŒè¯

4. **æ•°æ®æ˜ å°„**
   - å­—æ®µå¯¹åº”å…³ç³»
   - æ•°æ®ç±»å‹è½¬æ¢
   - å•ä½ç»Ÿä¸€

### **ç¬¬ä¸‰æ­¥ï¼šæ•°æ®ä¼ è¾“**
5. **åŒæ­¥ç­–ç•¥**
   - **å®æ—¶åŒæ­¥**ï¼šå³æ—¶æ•°æ®æ›´æ–°
   - **æ‰¹é‡åŒæ­¥**ï¼šå®šæ—¶æ‰¹é‡å¤„ç†
   - **å¢é‡åŒæ­¥**ï¼šåªä¼ è¾“å˜åŒ–æ•°æ®

6. **é”™è¯¯å¤„ç†**
   - é‡è¯•æœºåˆ¶
   - å¼‚å¸¸æ•°æ®è®°å½•
   - å¤±è´¥é€šçŸ¥

### **ç¬¬å››æ­¥ï¼šç›®æ ‡ç³»ç»Ÿ**
7. **æ•°æ®å†™å…¥**
   - å¤šç›®æ ‡æ•°æ®åº“
   - APIæ¥å£æ¨é€
   - æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨

8. **ä¸€è‡´æ€§ä¿è¯**
   - äº‹åŠ¡å¤„ç†
   - æ•°æ®æ ¡éªŒ
   - å›æ»šæœºåˆ¶

## ğŸ› ï¸ **æŠ€æœ¯å®ç°**
- ä½¿ç”¨n8nçš„DatabaseèŠ‚ç‚¹
- HTTP RequestèŠ‚ç‚¹å¤„ç†API
- FunctionèŠ‚ç‚¹å¤„ç†å¤æ‚é€»è¾‘
- SetèŠ‚ç‚¹è¿›è¡Œæ•°æ®è½¬æ¢

## ğŸ“Š **ç›‘æ§ä¸æŠ¥å‘Š**
- åŒæ­¥çŠ¶æ€ç›‘æ§
- æ€§èƒ½æŒ‡æ ‡è·Ÿè¸ª
- å¼‚å¸¸æŠ¥å‘Šç”Ÿæˆ

éœ€è¦æˆ‘è¯¦ç»†é…ç½®æŸä¸ªæ•°æ®æºçš„è¿æ¥å—ï¼Ÿ`;
  }

  // é»˜è®¤é€šç”¨å›å¤
  return `# ğŸ¤– n8n æ™ºèƒ½å·¥ä½œæµæ„å»ºåŠ©æ‰‹

æˆ‘ç†è§£æ‚¨æƒ³è¦æ„å»ºä¸€ä¸ªè‡ªåŠ¨åŒ–å·¥ä½œæµã€‚åŸºäºæ‚¨çš„éœ€æ±‚ï¼Œæˆ‘æ¥ä¸ºæ‚¨æä¾›ä¸€ä¸ªå®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼š

## ğŸ“‹ **é€šç”¨n8nå·¥ä½œæµæ„å»ºæ­¥éª¤**

### **1. è§¦å‘å™¨é€‰æ‹©**
æ ¹æ®æ‚¨çš„æ•°æ®æ¥æºé€‰æ‹©åˆé€‚çš„è§¦å‘å™¨ï¼š
- **Webhook** - æ¥æ”¶å¤–éƒ¨ç³»ç»Ÿæ¨é€
- **Schedule** - å®šæ—¶æ‰§è¡Œä»»åŠ¡
- **Manual** - æ‰‹åŠ¨è§¦å‘æ‰§è¡Œ
- **Database** - æ•°æ®åº“å˜æ›´ç›‘å¬

### **2. æ•°æ®å¤„ç†èŠ‚ç‚¹**
- **HTTP Request** - è°ƒç”¨å¤–éƒ¨API
- **Function** - è‡ªå®šä¹‰JavaScripté€»è¾‘
- **Set** - æ•°æ®æ ¼å¼è½¬æ¢
- **IF** - æ¡ä»¶åˆ†æ”¯åˆ¤æ–­

### **3. è¾“å‡ºæ“ä½œ**
- **Webhook Response** - è¿”å›å¤„ç†ç»“æœ
- **Send Email** - å‘é€é‚®ä»¶é€šçŸ¥
- **Slack/Discord** - å›¢é˜Ÿåä½œé€šçŸ¥
- **Google Sheets** - æ•°æ®å­˜å‚¨

### **4. é”™è¯¯å¤„ç†**
- **Error Trigger** - æ•è·æ‰§è¡Œé”™è¯¯
- **Retry** - å¤±è´¥é‡è¯•æœºåˆ¶
- **Log** - æ‰§è¡Œæ—¥å¿—è®°å½•

## ğŸš€ **å¿«é€Ÿå¼€å§‹å»ºè®®**

1. **æ˜ç¡®éœ€æ±‚**ï¼šç¡®å®šè¦è‡ªåŠ¨åŒ–çš„å…·ä½“æµç¨‹
2. **é€‰æ‹©æ¨¡æ¿**ï¼šä»n8nç¤¾åŒºæ¨¡æ¿å¼€å§‹
3. **é€æ­¥æ„å»º**ï¼šå…ˆç®€å•åå¤æ‚
4. **å……åˆ†æµ‹è¯•**ï¼šç¡®ä¿å„ç¯èŠ‚æ­£å¸¸å·¥ä½œ

## ğŸ’¡ **å®ç”¨æŠ€å·§**
- ä½¿ç”¨æµ‹è¯•æ•°æ®éªŒè¯æµç¨‹
- è®¾ç½®åˆé€‚çš„è¶…æ—¶æ—¶é—´
- æ·»åŠ æ—¥å¿—ä¾¿äºè°ƒè¯•
- è€ƒè™‘æ€§èƒ½å’Œèµ„æºæ¶ˆè€—

è¯·å‘Šè¯‰æˆ‘æ‚¨å…·ä½“æƒ³è¦å®ç°ä»€ä¹ˆåŠŸèƒ½ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›æ›´è¯¦ç»†çš„æŒ‡å¯¼ï¼æ¯”å¦‚ï¼š
- é‚®ä»¶è‡ªåŠ¨åŒ–å¤„ç†
- æ•°æ®åŒæ­¥å’Œå¤‡ä»½
- ç¤¾äº¤åª’ä½“ç®¡ç†
- æŠ¥å‘Šç”Ÿæˆ
- APIé›†æˆ

æ‚¨æƒ³ä»å“ªä¸ªæ–¹é¢å¼€å§‹å‘¢ï¼Ÿ`;
}

// å¯åŠ¨æœåŠ¡å™¨
app.listen(PORT, () => {
  console.log(`
ğŸš€ n8n Agent Assistant Backend Server is running!
ğŸ“ Port: ${PORT}
ğŸŒ Environment: ${process.env.NODE_ENV || 'development'}
â° Started at: ${new Date().toLocaleString('zh-CN')}

ğŸ“š Available endpoints:
  - GET  /health
  - POST /api/chat/session
  - POST /api/chat/message
  - GET  /
  `);
});